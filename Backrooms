local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local WALL_TEXTURE = "rbxassetid://3255302928"
local CEILING_TEXTURE = "rbxassetid://9961421597"
local FLOOR_TEXTURE = "rbxassetid://9302607585"

local CELL_SIZE = 40
local WALL_HEIGHT = 30
local RENDER_RADIUS = 4

local generated = {}

local function texture(part, id, face)
	local t = Instance.new("Texture")
	t.Texture = id
	t.Face = face
	t.StudsPerTileU = 8
	t.StudsPerTileV = 8
	t.Parent = part
end

local function wall(pos, size)
	local p = Instance.new("Part")
	p.Anchored = true
	p.Size = size
	p.Position = pos
	p.Parent = workspace
	texture(p, WALL_TEXTURE, Enum.NormalId.Front)
	texture(p, WALL_TEXTURE, Enum.NormalId.Back)
	return p
end

local function floor(pos)
	local p = Instance.new("Part")
	p.Anchored = true
	p.Size = Vector3.new(CELL_SIZE, 1, CELL_SIZE)
	p.Position = pos
	p.Parent = workspace
	texture(p, FLOOR_TEXTURE, Enum.NormalId.Top)
	return p
end

local function ceiling(pos)
	local p = Instance.new("Part")
	p.Anchored = true
	p.Size = Vector3.new(CELL_SIZE, 1, CELL_SIZE)
	p.Position = pos + Vector3.new(0, WALL_HEIGHT, 0)
	p.Parent = workspace
	texture(p, CEILING_TEXTURE, Enum.NormalId.Bottom)
	return p
end

local function pool(origin)
	for i = 1, 120 do
		local p = Instance.new("Part")
		p.Anchored = true
		p.Size = Vector3.new(300, 20, 300)
		p.Position = origin - Vector3.new(0, i * 20, 0)
		p.BrickColor = BrickColor.new("Really black")
		p.Parent = workspace
	end
end

local function generateCell(x, z)
	local key = x .. ":" .. z
	if generated[key] then return end
	generated[key] = true

	local base = Vector3.new(x * CELL_SIZE, 0, z * CELL_SIZE)

	if math.random(1, 80) == 1 then
		pool(base)
		return
	end

	floor(base)
	ceiling(base)

	if math.random() < 0.7 then
		wall(base + Vector3.new(0, WALL_HEIGHT / 2, CELL_SIZE / 2), Vector3.new(CELL_SIZE, WALL_HEIGHT, 1))
	end
	if math.random() < 0.7 then
		wall(base + Vector3.new(0, WALL_HEIGHT / 2, -CELL_SIZE / 2), Vector3.new(CELL_SIZE, WALL_HEIGHT, 1))
	end
	if math.random() < 0.7 then
		wall(base + Vector3.new(CELL_SIZE / 2, WALL_HEIGHT / 2, 0), Vector3.new(1, WALL_HEIGHT, CELL_SIZE))
	end
	if math.random() < 0.7 then
		wall(base + Vector3.new(-CELL_SIZE / 2, WALL_HEIGHT / 2, 0), Vector3.new(1, WALL_HEIGHT, CELL_SIZE))
	end
end

RunService.Heartbeat:Connect(function()
	for _, plr in pairs(Players:GetPlayers()) do
		local char = plr.Character
		if char and char:FindFirstChild("HumanoidRootPart") then
			local pos = char.HumanoidRootPart.Position
			local cx = math.floor(pos.X / CELL_SIZE)
			local cz = math.floor(pos.Z / CELL_SIZE)

			for x = -RENDER_RADIUS, RENDER_RADIUS do
				for z = -RENDER_RADIUS, RENDER_RADIUS do
					generateCell(cx + x, cz + z)
				end
			end
		end
	end
end)
