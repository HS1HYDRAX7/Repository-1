if game.CoreGui:FindFirstChild("ModernTopChat") then return end

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local GuiService = game:GetService("GuiService")
local player = Players.LocalPlayer

local inset = GuiService:GetGuiInset()

local gui = Instance.new("ScreenGui")
gui.Name = "ModernTopChat"
gui.ResetOnSpawn = false
gui.Parent = game.CoreGui
gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

local bubble = Instance.new("TextButton")
bubble.Size = UDim2.new(0,44,0,44)
bubble.Position = UDim2.new(0, inset.X + 78, 0, inset.Y + 4)
bubble.BackgroundColor3 = Color3.fromRGB(20,20,20)
bubble.BackgroundTransparency = 0.1
bubble.Text = "‚úâÔ∏è"
bubble.TextSize = 18
bubble.AutoButtonColor = false
bubble.Parent = gui

local bubbleCorner = Instance.new("UICorner", bubble)
bubbleCorner.CornerRadius = UDim.new(1,0)

local chatGui = Instance.new("Frame")
chatGui.Size = UDim2.new(0,0,0,0)
chatGui.Position = UDim2.new(0.5,0,0.55,0)
chatGui.AnchorPoint = Vector2.new(0.5,0.5)
chatGui.BackgroundColor3 = Color3.fromRGB(16,16,16)
chatGui.Visible = false
chatGui.Parent = gui
chatGui.ZIndex = 10

local chatCorner = Instance.new("UICorner", chatGui)
chatCorner.CornerRadius = UDim.new(0,16)

local top = Instance.new("Frame")
top.Size = UDim2.new(1,0,0,30)
top.BackgroundColor3 = Color3.fromRGB(22,22,22)
top.Parent = chatGui

local topCorner = Instance.new("UICorner", top)
topCorner.CornerRadius = UDim.new(0,16)

local close = Instance.new("TextButton")
close.Size = UDim2.new(0,26,0,26)
close.Position = UDim2.new(1,-32,0.5,0)
close.AnchorPoint = Vector2.new(0,0.5)
close.Text = "‚úñ"
close.TextSize = 14
close.AutoButtonColor = false
close.BackgroundColor3 = Color3.fromRGB(40,40,40)
close.Parent = top

local closeCorner = Instance.new("UICorner", close)
closeCorner.CornerRadius = UDim.new(1,0)

local messages = Instance.new("ScrollingFrame")
messages.Size = UDim2.new(1,-16,1,-78)
messages.Position = UDim2.new(0,8,0,36)
messages.CanvasSize = UDim2.new(0,0,0,0)
messages.ScrollBarImageTransparency = 1
messages.BackgroundTransparency = 1
messages.Parent = chatGui

local layout = Instance.new("UIListLayout", messages)
layout.Padding = UDim.new(0,6)

local input = Instance.new("TextBox")
input.Size = UDim2.new(1,-50,0,32)
input.Position = UDim2.new(0,8,1,-40)
input.PlaceholderText = "Mensagem..."
input.Text = ""
input.Font = Enum.Font.Gotham
input.TextSize = 13
input.TextColor3 = Color3.new(1,1,1)
input.BackgroundColor3 = Color3.fromRGB(26,26,26)
input.Parent = chatGui

local inputCorner = Instance.new("UICorner", input)
inputCorner.CornerRadius = UDim.new(0,10)

local send = Instance.new("TextButton")
send.Size = UDim2.new(0,32,0,32)
send.Position = UDim2.new(1,-40,1,-40)
send.Text = "üì®"
send.TextSize = 14
send.AutoButtonColor = false
send.BackgroundColor3 = Color3.fromRGB(40,40,40)
send.Parent = chatGui

local sendCorner = Instance.new("UICorner", send)
sendCorner.CornerRadius = UDim.new(1,0)

local function tween(o,p,t)
	TweenService:Create(o,TweenInfo.new(t,Enum.EasingStyle.Quad,Enum.EasingDirection.Out),p):Play()
end

local function addMessage(text)
	local m = Instance.new("TextLabel")
	m.Size = UDim2.new(1,-8,0,0)
	m.AutomaticSize = Y
	m.TextWrapped = true
	m.BackgroundColor3 = Color3.fromRGB(28,28,28)
	m.TextColor3 = Color3.fromRGB(230,230,230)
	m.Font = Enum.Font.Gotham
	m.TextSize = 13
	m.TextXAlignment = Left
	m.TextYAlignment = Top
	m.Text = text
	m.Parent = messages

	local mc = Instance.new("UICorner", m)
	mc.CornerRadius = UDim.new(0,10)

	task.wait()
	messages.CanvasSize = UDim2.new(0,0,0,layout.AbsoluteContentSize.Y + 6)
	messages.CanvasPosition = Vector2.new(0, math.max(0, messages.CanvasSize.Y.Offset - messages.AbsoluteWindowSize.Y))
end

local function hookPlayer(p)
	p.Chatted:Connect(function(msg)
		if msg:sub(1,2)=="/w" or msg:sub(1,9)=="/whisper" then
			addMessage("(PM) "..p.Name..": "..msg)
		else
			addMessage(p.Name..": "..msg)
		end
	end)
end

for _,p in ipairs(Players:GetPlayers()) do
	hookPlayer(p)
end

Players.PlayerAdded:Connect(hookPlayer)

send.MouseButton1Click:Connect(function()
	if input.Text ~= "" then
		game.ReplicatedStorage.DefaultChatSystemChatEvents.SayMessageRequest:FireServer(input.Text,"All")
		input.Text = ""
	end
end)

bubble.MouseButton1Click:Connect(function()
	if chatGui.Visible then return end
	chatGui.Visible = true
	tween(chatGui,{Size=UDim2.new(0,300,0,240)},0.25)
end)

close.MouseButton1Click:Connect(function()
	tween(chatGui,{Size=UDim2.new(0,0,0,0)},0.2)
	task.delay(0.2,function()
		chatGui.Visible = false
	end)
end)
